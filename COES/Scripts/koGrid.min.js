/*
===============================================================================
    Author:     Eric M. Barnard - @ericmbarnard                                
    License:    MIT (http://opensource.org/licenses/mit-license.php)           
                                                                               
    Description: Validation Library for KnockoutJS                             
===============================================================================
*/
(function(){var a=window.kg={};a.templates={};var b="__kg_selected__",c="koGridTmpl";a.labels={};var d={forEach:function(a,b){var c=a.length,d=0;for(;d<c;d++)a[d]!==undefined&&b(a[d],d)},forIn:function(a,b){var c;for(c in a)a.hasOwnProperty(c)&&b(a[c],c)}};d.newId=function(){var a=(new Date).getTime();return function(){return a+=1}}(),d.StringBuilder=function(){var a=[];this.append=function(b,c){var d=arguments.length,e=0,f="{0}",g=1;if(d>1)while(g<d){while(b.indexOf(f)!==-1)b=b.replace(f,arguments[g]);g++,e=g-1,f="{"+e.toString()+"}"}a.push(b)},this.toString=function(){var b=arguments[0];return b!==null&&b!==undefined?a.join(b):a.join("")}},a.utils=d,a.templates.defaultGridInnerTemplate=function(){return'<div class="kgTopPanel" data-bind="kgSize: $data.headerDim"><div class="kgHeaderContainer" style="position: relative; overflow-x: hidden" data-bind="kgSize: $data.headerDim"><div class="kgHeaderScroller" data-bind="kgHeaderRow: $data, kgSize: $data.headerScrollerDim"></div></div></div><div class="kgViewport" style="overflow: auto;" data-bind="kgSize: $data.viewportDim"><div class="kgCanvas" data-bind="kgRows: $data.rows, style: { height: $data.canvasHeight }" style="position: relative"></div></div><div class="kgFooterPanel" data-bind="kgFooter: $data, kgSize: $data.footerDim" style="position: relative;"></div>'},a.templates.generateHeaderTemplate=function(b){var c=new a.utils.StringBuilder,e=b.columns,f=b.showFilter;return d.forEach(e,function(a,b){a.field==="__kg_selected__"?(c.append("<div class=\"kgSelectionCell\" data-bind=\"kgHeader: { value: '{0}' }, css: { 'kgNoSort': {1} }\">",a.field,!a.allowSort),c.append('  <input type="checkbox" data-bind="checked: $parent.toggleSelectAll, visible: $parent.config.isMultiSelect"/>'),c.append("</div>")):a.field==="rowIndex"&&f?(c.append("<div data-bind=\"kgHeader: { value: '{0}' }, css: { 'kgNoSort': {1} }\">",a.field,!a.allowSort),c.append('      <div title="Filter Results" class="kgFilterBtn openBtn" data-bind="visible: !$data.filterVisible(), click: $parent.showFilter_Click"></div>'),c.append('      <div title="Close" class="kgFilterBtn closeBtn" data-bind="visible: $data.filterVisible, click: $parent.showFilter_Click"></div>'),c.append('      <div title="Clear Filters" class="kgFilterBtn clearBtn" data-bind="visible: $data.filterVisible, click: $parent.clearFilter_Click"></div>'),c.append("</div>")):(c.append("<div data-bind=\"kgHeader: { value: '{0}' }, css: { 'kgNoSort': {1} }\">",a.field,!a.allowSort),c.append("</div>"))}),c.toString()},a.templates.defaultHeaderCellTemplate=function(){var b=new a.utils.StringBuilder;return b.append("<div data-bind=\"click: $data.sort, css: { 'kgSorted': !$data.noSortVisible() }\">"),b.append('  <span data-bind="text: $data.displayName"></span>'),b.append('  <img class="kgSortImg" data-bind="visible: $data.allowSort() && $data.noSortVisible()" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAcAAAAJCAYAAAD+WDajAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAadEVYdFNvZnR3YXJlAFBhaW50Lk5FVCB2My41LjEwMPRyoQAAAEFJREFUKFNjYICC+vp6YyDeDcSCMDEwDRRQAuK7QPwfpAAuiSYBkkQoAHLOQAVgEjB6FYrxGBy8OvHaide1+PwJAMBIWUlZ9vlNAAAAAElFTkSuQmCC"/>'),b.append('  <img class="kgSortImg" data-bind="visible: $data.sortAscVisible" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAcAAAAJCAYAAAD+WDajAAAABGdBTUEAALGPC/xhBQAAAAlwSFlzAAAOwgAADsIBFShKgAAAABp0RVh0U29mdHdhcmUAUGFpbnQuTkVUIHYzLjUuMTAw9HKhAAAAPElEQVQoU2NggIL6+npjIN4NxIIwMTANFFAC4rtA/B+kAC6JJgGSRCgAcs5ABWASMHoVw////3HigZAEACKmlTwMfriZAAAAAElFTkSuQmCC"/>'),b.append('  <img class="kgSortImg" data-bind="visible: $data.sortDescVisible" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAcAAAAJCAYAAAD+WDajAAAABGdBTUEAALGPC/xhBQAAAAlwSFlzAAAOwgAADsIBFShKgAAAABp0RVh0U29mdHdhcmUAUGFpbnQuTkVUIHYzLjUuMTAw9HKhAAAAPUlEQVQoU2P4//8/Ay6MUwKkgQJJBnygvr7+DBD/x4JXMQAFlYD4LprkbriBaAoQEjAVQAXGQLwbiAVhYgD6kIBR+tr9IgAAAABJRU5ErkJggg=="/>'),b.append("</div>"),b.append('<div data-bind="visible: $parent.filterVisible">'),b.append('  <input type="text" data-bind="value: $data.column.filter, valueUpdate: \'afterkeydown\'" style="width: 80%" tabindex="1" />'),b.append("</div>"),b.toString()},a.templates.generateRowTemplate=function(b){var c=new a.utils.StringBuilder,e=b.columns;return c.append("<div data-bind=\"kgRow: $data, click: $data.toggleSelected, css: { 'kgSelected': $data.selected }\">"),d.forEach(e,function(b,d){if(b.field==="__kg_selected__")c.append('<div class="kgSelectionCell" data-bind="kgCell: { value: \'{0}\' } ">',b.field),c.append('  <input type="checkbox" data-bind="checked: $data.selected" />'),c.append("</div>");else if(b.field==="rowIndex")c.append('<div class="kgRowIndexCell" data-bind="kgCell: { value: \'{0}\' } "></div>',b.field);else if(b.hasCellTemplate){var e=a.templateManager.getTemplateText(b.cellTemplate),f="{ value: '"+b.field+"' }";e=e.replace(/\$cellClass/g,b.cellClass||"kgEmpty"),e=e.replace(/\$cellValue/g,"$data."+b.field),e=e.replace(/\$cell/g,f),c.append(e)}else c.append('  <div class="{0}"  data-bind="kgCell: { value: \'{1}\' } "></div>',b.cellClass||"kgEmpty",b.field)}),c.append("</div>"),c.toString()},a.templates.defaultFooterTemplate=function(){return'<div class="kgTotalSelectContainer" data-bind="visible: footerVisible"><div class="kgFooterTotalItems" data-bind="css: {\'kgNoMultiSelect\': !isMultiSelect()}" ><span class="kgLabel">Total Items:</span> <span data-bind="text: maxRows"></span></div><div class="kgFooterSelectedItems" data-bind="visible: isMultiSelect"><span class="kgLabel">Selected Items:</span> <span data-bind="text: selectedItemCount"></span></div></div><div class="kgPagerContainer" data-bind="visible: pagerVisible() && footerVisible(), css: {\'kgNoMultiSelect\': !isMultiSelect()}"><div style="float: right;"><div class="kgRowCountPicker"><span class="kgLabel">Rows:</span><select data-bind="options: pageSizes, value: selectedPageSize"></select></div><div class="kgPagerControl" style="float: left; min-width: 135px;"><input class="kgPagerFirst" type="button" data-bind="click: pageToFirst, enable: canPageBackward" title="First Page"/><input class="kgPagerPrev" type="button"  data-bind="click: pageBackward, enable: canPageBackward" title="Previous Page"/><input class="kgPagerCurrent" type="text" data-bind="value: protectedCurrentPage, enable: maxPages() > 1" /><input class="kgPagerNext" type="button"  data-bind="click: pageForward, enable: canPageForward" title="Next Page"/><input class="kgPagerLast" type="button"  data-bind="click: pageToLast, enable: canPageForward" title="Last Page"/></div></div></div>'},a.templateManager=new function(){var b=this,d=function(a){var b=document.getElementById(a);return b!==undefined&&b!==null},e=function(a,b){var c=document.createElement("SCRIPT");c.type="text/html",c.id=b,c.text=a,document.body.appendChild(c)};this.addTemplateSafe=function(a,b){d(a)||e(b(),a)},this.ensureGridTemplates=function(d){var e={rowTemplate:"",headerTemplate:"",headerCellTemplate:"",footerTemplate:"",columns:null,showFilter:!0},f=$.extend(e,d);b.addTemplateSafe(c,a.templates.defaultGridInnerTemplate),f.headerTemplate&&b.addTemplateSafe(f.headerTemplate,function(){return a.templates.generateHeaderTemplate(f)}),f.headerCellTemplate&&b.addTemplateSafe(f.headerCellTemplate,a.templates.defaultHeaderCellTemplate),f.rowTemplate&&b.addTemplateSafe(f.rowTemplate,function(){return a.templates.generateRowTemplate(f)}),f.footerTemplate&&b.addTemplateSafe(f.footerTemplate,a.templates.defaultFooterTemplate)},this.getTemplateText=function(a){if(!d(a))return"";var b=document.getElementById(a);return b.text}},a.Dimension=function(a){this.innerHeight=null,this.innerWidth=null,this.outerHeight=null,this.outerWidth=null,this.widthDiff=null,this.heightDiff=null,this.autoFitHeight=!1,this.autoFitWidth=!1,$.extend(this,a)},a.Cell=function(a){this.data="",this.column=a,this.row=null},a.Column=function(b){this.width=ko.observable(0),this.field=b.field;if(b.displayName===undefined||b.displayName===null)b.displayName=b.field;this.displayName=b.displayName,this.colIndex=0,this.isVisible=ko.observable(!1),this.width=ko.observable();if(b.sortable===undefined||b.sortable===null)b.sortable=!0;this.allowSort=b.sortable,this.sortDirection=ko.observable(""),this.filter=ko.observable(),this.cellTemplate=b.cellTemplate,this.hasCellTemplate=this.cellTemplate?!0:!1,this.cellClass=b.cellClass,this.headerClass=b.headerClass,this.headerTemplate=b.headerTemplate,this.hasHeaderTemplate=this.headerTemplate?!0:!1,b.width||(b.width=this.displayName.length*a.domUtility.letterW,b.width+=30),this.width(b.width)},a.ColumnCollection=function(){var b=ko.observableArray([]);return ko.utils.extend(b,a.ColumnCollection.fn),b},a.ColumnCollection.fn={},a.Row=function(a,b){var c=this,e=b.canSelectRows;this.entity=ko.isObservable(a)?a:ko.observable(a),this.entity().__kg_selected__===undefined&&(this.entity().__kg_selected__=ko.observable(!1)),this.selected=ko.dependentObservable({read:function(){if(!e)return!1;var a=c.entity().__kg_selected__();return a},write:function(a){if(!e)return!0;c.entity().__kg_selected__(a),c.onSelectionChanged()}}),this.toggleSelected=function(a,b){if(!e)return!0;var d=b.target;return d.type=="checkbox"&&d.parentElement.className.indexOf(!0)?!0:(c.selected()?c.selected(!1):c.selected(!0),!0)},this.cells=ko.observableArray([]),this.cellMap={},this.rowIndex=0,this.offsetTop=0,this.rowKey=d.newId(),this.rowDisplayIndex=0,this.onSelectionChanged=function(){},function(){d.forIn(a,function(a,b){c[b]=a})}()},a.Range=function(a,b){this.topRow=b,this.bottomRow=a},a.CellFactory=function(b){var c=b,d=c.length;this.buildRowCells=function(b){var e,f=[],g,h=0;for(;h<d;h++)g=c[h],e=new a.Cell(g),e.row=b,e.data=b.entity()[g.field],f.push(e),b.cellMap[g.field]=e;return b.cells(f),b}},a.HeaderCell=function(a){var b=this;this.colIndex=0,this.displayName=a.displayName,this.field=a.field,this.column=a,this.headerClass=a.headerClass,this.headerTemplate=a.headerTemplate,this.hasHeaderTemplate=a.hasHeaderTemplate,this.width=ko.computed(function(){return a.width()}),this.filter=ko.computed({read:function(){return b.column.filter()},write:function(a){b.column.filter(a)}}),this.filterVisible=ko.observable(!1),this.allowSort=ko.observable(a.allowSort),this.sortAscVisible=ko.computed(function(){return b.column.sortDirection()==="asc"}),this.sortDescVisible=ko.computed(function(){return b.column.sortDirection()==="desc"}),this.noSortVisible=ko.computed(function(){var a=b.column.sortDirection();return a!=="asc"&&a!=="desc"}),this.sort=function(){if(!b.allowSort())return;var a=b.column.sortDirection()==="asc"?"desc":"asc";b.column.sortDirection(a)},this.filterHasFocus=ko.observable(!1)},a.HeaderRow=function(){this.headerCells=[],this.height,this.headerCellMap={},this.filterVisible=ko.observable(!1)},a.RowManager=function(b){var c=this,e={},f=0,g=0,h=!0,i=b.config.currentPage,j=b.config.pageSize,k=new a.Range(0,1),l=new a.Range(0,1),m=ko.observable(k);this.dataSource=b.finalData,this.dataSource.subscribe(function(){h=!0,e={}}),this.minViewportRows=b.minRowsToRender,this.excessRows=8,this.rowHeight=b.config.rowHeight,this.cellFactory=new a.CellFactory(b.columns()),this.viewableRange=ko.observable(l),this.renderedRange=ko.observable(k),this.rows=ko.observableArray([]),this.rowSubscriptions={};var n=function(d,f,g){var h=e[f];return h||(h=new a.Row(d,b.config),h.rowIndex=f+1,h.rowDisplayIndex=h.rowIndex+g,h.offsetTop=c.rowHeight*f,h.onSelectionChanged=function(){var a=this.entity();b.changeSelectedItem(a)},c.cellFactory.buildRowCells(h),e[f]=h),h};this.renderedRange.subscribe(function(a){var b=[],e,f=j()*(i()-1),g=c.dataSource().slice(a.bottomRow,a.topRow);d.forEach(g,function(c,d){e=n(c,a.bottomRow+d,f),b.push(e),e=null}),c.rows(b)});var o=function(){var b=c.viewableRange(),d=c.minViewportRows(),e=c.dataSource().length,i=!1,j;if(b){i=b.bottomRow!==l.bottomRow||b.topRow!==l.topRow||h,!i&&f!==e&&(i=!0,b=new a.Range(l.bottomRow,l.topRow)),!i&&g!==d&&(i=!0,b=new a.Range(l.bottomRow,l.topRow));if(i){b.topRow=b.bottomRow+d,l=b,j=new a.Range(b.bottomRow,b.topRow),j.bottomRow=Math.max(0,b.bottomRow-c.excessRows),j.topRow=Math.min(e,b.topRow+c.excessRows),f=e,g=d;if(k.topRow!==j.topRow||k.bottomRow!==j.bottomRow||h)h=!1,k=j,c.renderedRange(j)}}else c.renderedRange(new a.Range(0,0))};c.viewableRange.subscribe(o),c.minViewportRows.subscribe(o),c.dataSource.subscribe(o)},a.Footer=function(a){var b=this;this.maxRows,a.config.totalServerItems()!==null&&a.config.totalServerItems()!==undefined?this.maxRows=a.config.totalServerItems:this.maxRows=a.maxRows,this.isMultiSelect=ko.observable(a.config.canSelectRows&&a.config.isMultiSelect),this.selectedItemCount=a.selectedItemCount,this.footerVisible=a.config.footerVisible,this.pagerVisible=ko.observable(a.config.enablePaging),this.selectedPageSize=a.config.pageSize,this.pageSizes=ko.observableArray(a.config.pageSizes),this.currentPage=a.config.currentPage,this.maxPages=ko.computed(function(){var a=b.maxRows()||1,c=b.selectedPageSize();return Math.ceil(a/c)}),this.protectedCurrentPage=ko.computed({read:function(){return b.currentPage()},write:function(a){a&&a<=b.maxPages()&&a>0&&b.currentPage(a)},owner:b}),this.pageForward=function(){var a=b.currentPage();b.currentPage(Math.min(a+1,b.maxPages()))},this.pageBackward=function(){var a=b.currentPage();b.currentPage(Math.max(a-1,1))},this.pageToFirst=function(){b.currentPage(1)},this.pageToLast=function(){var a=b.maxPages();b.currentPage(a)},this.canPageForward=ko.computed(function(){var a=b.currentPage(),c=b.maxPages();return a<c}),this.canPageBackward=ko.computed(function(){var a=b.currentPage();return a>1})},a.FilterManager=function(a){var b=this,c=a.filterWildcard||"*",d=a.includeDestroyed||!1,e={},f=0,g=ko.observableArray([]);if(c!=="*"&&c!=="%")throw new Error("You can only declare a percent sign (%) or an asterisk (*) as a wildcard character");var h=function(a){return ko.utils.arrayFilter(a,function(a){return a._destroy===!0?!1:!0})};this.filterInfo=a.filterInfo||ko.observable(),this.data=a.data,this.filteredData=ko.computed(function(){var a=g();return f>0?a:h(b.data())});var i=function(a){return a===null||a===undefined||a===""},j=function(a,b){var d=e[b];if(!d){var f="";b=b.replace(/\\/g,"\\"),c==="*"?f=/\*/g:f=/\%/g;var g=b.replace(f,"[^']*");g!=="*"&&(g="^"+g);try{d=new RegExp(g,"gi")}catch(h){d=/.*/gi}e[b]=d}return a.match(d)},k=function(){var d=b.filterInfo(),f=b.data(),k=!1,l=!0,m=[],n,o,p,q;f=h(f);if(!d||$.isEmptyObject(d)||a.useExternalFiltering){g(f);return}e={},m=ko.utils.arrayFilter(f,function(a){var b,e;for(n in d){if(d.hasOwnProperty(n)){b=n.split("."),o=a;for(e=0;e<b.length&&o!==undefined&&o!==null;e++)o=ko.utils.unwrapObservable(o[b[e]]);q=d[n],!i(q)&&q!==c&&(i(o)?l=!1:typeof o=="string"?l=j(o,q):(p=o.toString(),l=j(p,q)))}k&&!l?k=!1:!k&&l&&(k=!0);if(!l)break}return q=null,o=null,p=null,l=!0,k}),g(m)};this.data.subscribe(k),this.filterInfo.subscribe(k),this.createFilterChangeCallback=function(a){return function(c){var d=b.filterInfo();if(!d&&!c)return;d||(d={}),c!==null&&c!==undefined&&c!==""||!d[a.field]?c!==null&&c!==undefined&&(d[a.field]=c):delete d[a.field],b.filterInfo(d)}},f=1},a.SortManager=function(a){var b=this,c={},d=/^(\d\d?)[\/\.-](\d\d?)[\/\.-]((\d\d)?\d\d)$/,e="asc",f="desc",g={},h=a.data,i=0,j=ko.observableArray([]),k=function(a){return a===null||a===undefined||a===""};this.sortInfo=a.sortInfo||ko.observable(),this.sortedData=ko.computed(function(){var a=j();return i>0?a:h()}),this.guessSortFn=function(a){var c,e,f,g,h,i;if(a===undefined||a===null||a==="")return null;f=typeof a;switch(f){case"number":c=b.sortNumber;break;case"boolean":c=b.sortBool}return c?c:Object.prototype.toString.call(a)==="[object Date]"?b.sortDate:f!=="string"?null:a.match(/^-?[£$¤]?[\d,.]+%?$/)?b.sortNumberStr:(g=a.match(d),g?(h=parseInt(g[1]),i=parseInt(g[2]),h>12?b.sortDDMMStr:i>12?b.sortMMDDStr:b.sortMMDDStr):b.sortAlpha)},this.sortNumber=function(a,b){return a-b},this.sortNumberStr=function(a,b){var c,d,e=!1,f=!1;return c=parseFloat(a.replace(/[^0-9.-]/g,"")),isNaN(c)&&(e=!0),d=parseFloat(b.replace(/[^0-9.-]/g,"")),isNaN(d)&&(f=!0),e&&f?0:e?1:f?-1:c-d},this.sortAlpha=function(a,b){var c=a.toUpperCase(),d=b.toUpperCase();return c==d?0:c<d?-1:1},this.sortDate=function(a,b){var c=a.getTime(),d=b.getTime();return c==d?0:c<d?-1:1},this.sortBool=function(a,b){return a&&b?0:!a&&!b?0:a?1:-1},this.sortDDMMStr=function(a,b){var c,e,f,g,h,i;return f=a.match(d),i=f[3],g=f[2],h=f[1],g.length==1&&(g="0"+g),h.length==1&&(h="0"+h),c=i+g+h,f=b.match(d),i=f[3],g=f[2],h=f[1],g.length==1&&(g="0"+g),h.length==1&&(h="0"+h),e=i+g+h,c==e?0:c<e?-1:1},this.sortMMDDStr=function(a,b){var c,e,f,g,h,i;return f=a.match(d),i=f[3],h=f[2],g=f[1],g.length==1&&(g="0"+g),h.length==1&&(h="0"+h),c=i+g+h,f=b.match(d),i=f[3],h=f[2],g=f[1],g.length==1&&(g="0"+g),h.length==1&&(h="0"+h),e=i+g+h,c==e?0:c<e?-1:1},this.sort=function(a,c){if(a===g.column&&c===g.direction)return;b.sortInfo({column:a,direction:c})};var l=function(){var d=h(),f=b.sortInfo(),g,i,l,m,n,o,p;if(!d||!f||a.useExternalSorting){j(d);return}g=f.column,i=f.direction;if(c[g.field])l=c[g.field];else{m=h()[0];if(m){n=g.field.split("."),o=m;for(p=0;p<n.length&&o!==undefined&&o!==null;p++)o=ko.utils.unwrapObservable(o[n[p]])}l=b.guessSortFn(o),l?c[g.field]=l:l=b.sortAlpha}d.sort(function(a,b){var c=a,d=b,f=!1,h=!1,j,m;j=g.field.split(".");for(m=0;m<j.length;m++)c!==undefined&&c!==null&&(c=ko.utils.unwrapObservable(c[j[m]])),d!==undefined&&d!==null&&(d=ko.utils.unwrapObservable(d[j[m]]));return f=k(c),h=k(d),f&&h?0:f?1:h?-1:i===e?l(c,d):0-l(c,d)}),j(d)};h.subscribe(l),this.sortInfo.subscribe(l),i=1},a.SelectionManager=function(a){var b=this,c=a.isMultiSelect,e=a.data,f="__kg_selected__",g=ko.computed(function(){return e().length});this.selectedItem=a.selectedItem,this.selectedItems=a.selectedItems,this.selectedIndex=a.selectedIndex,this.selectedItemCount=ko.computed(function(){var a=b.selectedItem(),d=b.selectedItems();return c?d.length:a!==null&&a!==undefined?1:0}),this.selectedItem.subscribe(function(a){c||a&&a[f]&&a[f](!1)},b,"beforeChange"),this.selectedItem.subscribe(function(a){a&&!a[f]?a[f]=ko.observable(!0):a&&a[f](!0)}),this.selectedItems.subscribe(function(a){var b=e();a||(a=[]),d.forEach(b,function(b,c){b[f]||(b[f]=ko.observable(!1)),ko.utils.arrayIndexOf(a,b)>-1?b[f](!0):b[f](!1)})}),this.changeSelectedItem=function(a){var d=b.selectedItem(),e=b.selectedItems,g=0,h=!1;c?(g=e().length,a&&a[f]&&(h=a[f]()),h?e.indexOf(a)===-1&&e.push(a):e.remove(a)):(a&&a[f]&&(h=a[f]()),h?b.selectedItem(a):a[f](!0))},this.toggleSelectAll=ko.computed({read:function(){var a=b.selectedItemCount();return c?g()===0?!1:a===g():a===1},write:function(a){var f=a,g=[];c&&(d.forEach(e(),function(a){g.push(a)}),f?b.selectedItems(g):b.selectedItems([]))}}),e.subscribe(function(a){var d,e,f;if(!a)return;c?(d=b.selectedItems(),f=[],ko.utils.arrayForEach(d,function(b){ko.utils.arrayIndexOf(a,b)<0&&f.push(b)}),f.length>0&&b.selectedItems.removeAll(f)):(e=b.selectedItem(),e&&ko.utils.arrayIndexOf(a,e)<0&&b.selectedItem(a[0]?a[0]:null))})},a.gridManager=new function(){var b=this,c="__koGrid__";this.gridCache={},this.storeGrid=function(a,d){b.gridCache[d.gridId]=d,a[c]=d.gridId},this.getGrid=function(a){var d;return a[c]&&(d=b.gridCache[a[c]]),d},this.clearGridCache=function(){b.gridCache={}},this.assignGridEventHandlers=function(b){b.$viewport.scroll(function(a){var c=a.target.scrollLeft,d=a.target.scrollTop;b.adjustScrollLeft(c),b.adjustScrollTop(d)});var c=b.$root.parent();c.length==0&&(c=b.$root),$(window).resize(function(){var c={rootMaxH:b.elementDims.rootMaxH,rootMaxW:b.elementDims.rootMaxW,rootMinH:b.elementDims.rootMinH,rootMinW:b.elementDims.rootMinW},d=0,e=!1,f=b.$root.parents(":hidden");if(f.length>0)return;d=b.$viewport.scrollTop(),a.domUtility.measureGrid(b.$root,b);if(c.rootMaxH!==b.elementDims.rootMaxH&&b.elementDims.rootMaxH!==0)e=!0;else if(c.rootMaxW!==b.elementDims.rootMaxW&&b.elementDims.rootMaxW!==0)e=!0;else if(c.rootMinH!==b.elementDims.rootMinH)e=!0;else if(c.rootMinW!==b.elementDims.rootMinW)e=!0;else return;e&&(b.refreshDomSizes(),b.adjustScrollTop(d,!0))})}},a.KoGrid=function(b){var c={rowHeight:30,columnWidth:100,headerRowHeight:30,footerRowHeight:55,filterRowHeight:30,rowTemplate:"kgRowTemplate",headerTemplate:"kgHeaderRowTemplate",headerCellTemplate:"kgHeaderCellTemplate",footerTemplate:"kgFooterTemplate",footerVisible:ko.observable(!0),autogenerateColumns:!0,data:null,columnDefs:[],pageSizes:[250,500,1e3],enablePaging:!1,pageSize:ko.observable(250),totalServerItems:ko.observable(),currentPage:ko.observable(1),selectedItem:ko.observable(),selectedItems:ko.observableArray([]),selectedIndex:ko.observable(0),canSelectRows:!0,isMultiSelect:!0,displaySelectionCheckbox:!0,displayRowIndex:!0,useExternalFiltering:!1,useExternalSorting:!1,filterInfo:ko.observable(),sortInfo:ko.observable(),filterWildcard:"*",includeDestroyed:!1},e=this,f=ko.observable(!1),g,h,i,j=!1,k,l,m,n=0,o;this.$root,this.$topPanel,this.$headerContainer,this.$headerScroller,this.$headers,this.$viewport,this.$canvas,this.$footerPanel,this.config=$.extend(c,b),this.gridId="kg"+a.utils.newId(),this.initPhase=0,this.config.footerRowHeight===c.footerRowHeight&&(!this.config.canSelectRows||!this.config.isMultiSelect)&&(c.footerRowHeight=30,this.config.footerRowHeight=30),this.data=e.config.data,g=new a.FilterManager(e.config),h=new a.SortManager({data:g.filteredData,sortInfo:e.config.sortInfo,useExternalSorting:e.config.useExternalSorting}),this.sortInfo=h.sortInfo,this.filterInfo=g.filterInfo,this.finalData=h.sortedData,this.canvasHeight=ko.observable(n.toString()+"px"),i=new a.SelectionManager({isMultiSelect:e.config.isMultiSelect,data:e.finalData,selectedItem:e.config.selectedItem,selectedItems:e.config.selectedItems,selectedIndex:e.config.selectedIndex}),this.maxRows=ko.computed(function(){var a=e.finalData();return n=a.length*e.config.rowHeight,e.canvasHeight(n.toString()+"px"),a.length||0}),this.maxCanvasHeight=function(){return n||0},this.selectedItemCount=i.selectedItemCount,this.columns=new a.ColumnCollection,this.rowManager,this.rows,this.headerRow,this.footer,this.elementDims={scrollW:0,scrollH:0,cellHdiff:0,cellWdiff:0,rowWdiff:0,rowHdiff:0,rowIndexCellW:35,rowSelectedCellW:25,rootMaxW:0,rootMaxH:0,rootMinW:0,rootMinH:0},this.elementsNeedMeasuring=!0,this.rootDim=ko.observable(new a.Dimension({outerHeight:2e4,outerWidth:2e4})),this.headerDim=ko.computed(function(){var b=e.rootDim(),c=f(),d=new a.Dimension;return d.outerHeight=e.config.headerRowHeight,d.outerWidth=b.outerWidth,c&&(d.outerHeight+=e.config.filterRowHeight),d}),this.footerDim=ko.computed(function(){var b=e.rootDim(),c=e.config.footerVisible(),d=new a.Dimension;return d.outerHeight=e.config.footerRowHeight,d.outerWidth=b.outerWidth,c||(d.outerHeight=3),d}),this.viewportDim=ko.computed(function(){var b=e.rootDim(),c=e.headerDim(),d=e.footerDim(),f=new a.Dimension;return f.outerHeight=b.outerHeight-c.outerHeight-d.outerHeight,f.outerWidth=b.outerWidth,f.innerHeight=f.outerHeight,f.innerWidth=f.outerWidth,f}),this.totalRowWidth=ko.computed(function(){var a=0,b=e.columns();return d.forEach(b,function(b,c){a+=b.width()}),a}),this.minRowsToRender=ko.computed(function(){var a=e.viewportDim().outerHeight||1;return f()?m:(m=Math.floor(a/e.config.rowHeight),m)}),this.headerScrollerDim=ko.computed(function(){var b=e.viewportDim().outerHeight,c=f(),d=e.maxCanvasHeight(),g=d>b,h=e.viewportDim().outerWidth<e.totalRowWidth();return newDim=new a.Dimension,newDim.autoFitHeight=!0,newDim.outerWidth=e.totalRowWidth(),g?newDim.outerWidth+=e.elementDims.scrollW:d-b<=e.elementDims.scrollH&&(newDim.outerWidth+=e.elementDims.scrollW),newDim}),this.changeSelectedItem=i.changeSelectedItem,this.toggleSelectAll=i.toggleSelectAll,this.sortData=function(a,b){j=!0,d.forEach(e.columns(),function(b){b.field!==a.field&&b.sortDirection()!==""&&b.sortDirection("")}),h.sort(a,b),j=!1},this.finalData.subscribe(function(){var a;e.config.isMultiSelect&&e.config.selectedItems()?a=e.config.selectedItems()[0]:e.config.selectedItem()&&(a=e.config.selectedItem()),a&&p(a)});var p=function(b){var c,d=e.rowManager.viewableRange();b&&(c=ko.utils.arrayIndexOf(e.finalData(),b)),c>-1&&(c>d.topRow||c<d.bottomRow-5)&&(e.rowManager.viewableRange(new a.Range(c,c+e.minRowsToRender())),e.$viewport&&e.$viewport.scrollTop(c*e.config.rowHeight))};this.refreshDomSizes=function(){var b=new a.Dimension,c=e.rootDim(),d=0,f=0,g=0;e.elementsNeedMeasuring=!0,d=e.maxCanvasHeight()+e.config.headerRowHeight+e.config.footerRowHeight,d=Math.min(e.elementDims.rootMaxH,d),d=Math.max(e.elementDims.rootMinH,d),g=d-e.config.headerRowHeight-e.config.footerRowHeight,f=e.totalRowWidth()+e.elementDims.rowWdiff,e.maxCanvasHeight()>g&&(f+=e.elementDims.scrollW||0),b.outerWidth=Math.min(e.elementDims.rootMaxW,f),b.outerWidth=Math.max(e.elementDims.rootMinW,b.outerWidth),b.outerHeight=d,(b.outerHeight!==c.outerHeight||b.outerWidth!==c.outerWidth)&&e.rootDim(b)},this.refreshDomSizesTrigger=ko.computed(function(){var b=e.data();o&&(window.setImmediate?window.clearImmediate(o):window.clearTimeout(o)),e.initPhase>0&&!f()&&!j&&(e.refreshDomSizes(),a.cssBuilder.buildStyles(e),e.initPhase>0&&e.$root&&e.$root.show())});var q=function(){var a;if(!e.data()||!e.data()[0])throw'If auto-generating columns, "data" cannot be of null or undefined type!';a=e.data()[0],d.forIn(a,function(a,b){if(b==="__kg_selected__")return;e.config.columnDefs.push({field:b})})},r=function(){var b=e.config.columnDefs,c=[],f;e.config.autogenerateColumns&&q(),e.config.displaySelectionCheckbox&&b.splice(0,0,{field:"__kg_selected__",width:e.elementDims.rowSelectedCellW}),e.config.displayRowIndex&&b.splice(0,0,{field:"rowIndex",width:e.elementDims.rowIndexCellW});var h=function(a){return function(b){b&&e.sortData(a,b)}};b.length>0&&(d.forEach(b,function(b,d){f=new a.Column(b),f.index=d,f.sortDirection.subscribe(h(f)),f.filter.subscribe(g.createFilterChangeCallback(f)),c.push(f)}),e.columns(c))};this.init=function(){r(),e.config.rowTemplate==="kgRowTemplate"&&(e.config.rowTemplate=e.gridId+e.config.rowTemplate),e.config.headerTemplate==="kgHeaderRowTemplate"&&(e.config.headerTemplate=e.gridId+e.config.headerTemplate),e.rowManager=new a.RowManager(e),e.rows=e.rowManager.rows,a.cssBuilder.buildStyles(e),e.initPhase=1},this.update=function(){var b=function(){e.refreshDomSizes(),a.cssBuilder.buildStyles(e),e.initPhase>0&&e.$root&&e.$root.show()};window.setImmediate?o=setImmediate(b):o=setTimeout(b,0)},this.showFilter_Click=function(){var a=f()?!1:!0;e.headerRow.filterVisible(a),f(a)},this.clearFilter_Click=function(){d.forEach(e.columns(),function(a,b){a.filter(null)})},this.adjustScrollTop=function(b,c){var d;if(k===b&&!c)return;d=Math.floor(b/e.config.rowHeight),k=b,e.rowManager.viewableRange(new a.Range(d,d+e.minRowsToRender()))},this.adjustScrollLeft=function(a){e.$headerContainer&&e.$headerContainer.scrollLeft(a)},e.init()},a.cssBuilder={buildStyles:function(b){var c=b.config.rowHeight-b.elementDims.rowHdiff,d=b.config.headerRowHeight,e=b.$styleSheet,f=b.gridId,g,h=0,i=b.columns().length,j=new a.utils.StringBuilder,k,l=0,m;e||(e=$("<style type='text/css' rel='stylesheet' />").appendTo($("head"))),e.empty(),j.append(".{0} .kgCanvas { width: {1}px; }",f,b.totalRowWidth()),j.append(".{0} .kgCell { height: {1}px; }",f,c),j.append(".{0} .kgRow { position: absolute; left: 0; right: 0; height: {1}px; line-height: {1}px; display: inline; }",f,c),j.append(".{0} .kgHeaderCell { top: 0; bottom: 0; }",f,d),j.append(".{0} .kgHeaderScroller { line-height: {1}px; overflow: none; }",f,d);for(;h<i;h++)k=b.columns()[h],m=k.width()-b.elementDims.cellWdiff,j.append(".{0} .col{1} { left: {2}px; right: {3}px; width: {4}px; }",f,h,l,b.totalRowWidth()-l-k.width(),m),l+=k.width();e[0].styleSheet?e[0].styleSheet.cssText=j.toString(" "):e[0].appendChild(document.createTextNode(j.toString(" "))),b.$styleSheet=e}},a.domUtility=new function(){var b=$("<div></div>"),c=this,d=function(a){if(!a)return 0;var b=a.replace("/px/gi",""),c=parseInt(b,10);return isNaN(c)?0:c};this.assignGridContainers=function(a,b){b.$root=$(a),b.$topPanel=$(".kgTopPanel",b.$root[0]),b.$headerContainer=$(".kgHeaderContainer",b.$topPanel[0]),b.$headerScroller=$(".kgHeaderScroller",b.$headerContainer[0]),b.$headers=b.$headerContainer.children(),b.$viewport=$(".kgViewport",b.$root[0]),b.$canvas=$(".kgCanvas",b.$viewport[0]),b.$footerPanel=$(".kgFooterPanel",b.$root[0])},this.measureElementMaxDims=function(a){var b={},c=$("<div style='height: 20000px; width: 20000px;'></div>");a.append(c),b.maxWidth=a.width(),b.maxHeight=a.height();if(!b.maxWidth){var e=a.css("max-width");b.maxWidth=d(e)}if(!b.maxHeight){var e=a.css("max-height");b.maxHeight=d(e)}return b.maxWidth===0&&(b.maxWidth=a.parent().width()),b.maxHeight===0&&(b.maxHeight=a.parent().height()),c.remove(),b},this.measureElementMinDims=function(a){var b={},c=a.clone();c.appendTo(a.parent().first()),b.minWidth=0,b.minHeight=0,c.empty();var e=$("<div style='height: 0x; width: 0px;'></div>");c.append(e),b.minWidth=c.width(),b.minHeight=c.height();if(!b.minWidth){var f=c.css("min-width");b.minWidth=d(f)}if(!b.minHeight){var f=c.css("min-height");b.minHeight=d(f)}return c.remove(),b},this.measureGrid=function(b,d,e){var f=c.measureElementMaxDims(b);d.elementDims.rootMaxW=f.maxWidth,d.elementDims.rootMaxH=f.maxHeight,d.elementDims.scrollW=a.domUtility.scrollW,d.elementDims.scrollH=a.domUtility.scrollH,f=c.measureElementMinDims(b),d.elementDims.rootMinW=f.minWidth,f.minHeight=Math.max(f.minHeight,d.config.headerRowHeight+d.config.footerRowHeight+3*d.config.rowHeight),f.minHeight=Math.min(d.elementDims.rootMaxH,f.minHeight),d.elementDims.rootMinH=f.minHeight},this.measureRow=function(a,b){var c,d,e,f;c=a.children().first(),c.length===0&&(a.append('<div class="kgRow"></div>'),c=a.children().first(),e=!0),d=c.children().first(),d.length===0&&(c.append('<div class="kgCell col0"></div>'),d=c.children().first(),f=!0),b.elementDims.rowWdiff=c.outerWidth()-c.width(),b.elementDims.rowHdiff=c.outerHeight()-c.height(),b.elementDims.cellWdiff=d.outerWidth()-d.width(),b.elementDims.cellHdiff=d.outerHeight()-d.height(),b.elementsNeedMeasuring=!1,e?c.remove():f&&d.remove()},this.scrollH=17,this.scrollW=17,this.letterW=5,$(function(){b.appendTo("body"),b.height(100).width(100).css("position","absolute").css("overflow","scroll"),b.append('<div style="height: 400px; width: 400px;"></div>'),c.scrollH=b.height()-b[0].clientHeight,c.scrollW=b.width()-b[0].clientWidth,b.empty(),b.attr("style",""),b.append('<span style="font-family: Verdana, Helvetica, Sans-Serif; font-size: 14px;"><strong>M</strong></span>'),c.letterW=b.children().first().width(),b.remove()})},ko.bindingHandlers.kgWith=function(){return{init:function(a,b,c,d,e){var f=ko.utils.unwrapObservable(b()),g=e.createChildContext(f);if(!f)throw Error("Cannot use a null or undefined value with the 'kgWith' binding");return ko.applyBindingsToDescendants(g,a),{controlsDescendantBindings:!0}}}}(),ko.bindingHandlers.koGrid=function(){var b=function(a){return function(){return{name:c,data:a}}};return{init:function(c,d,e,f,g){var h,i=d(),j=$(c);return h=new a.KoGrid(i),a.gridManager.storeGrid(c,h),a.domUtility.measureGrid(j,h,!0),j.hide(),$(c).addClass("kgGrid").addClass("ui-widget").addClass(h.gridId.toString()),a.templateManager.ensureGridTemplates({rowTemplate:h.config.rowTemplate,headerTemplate:h.config.headerTemplate,headerCellTemplate:h.config.headerCellTemplate,footerTemplate:h.config.footerTemplate,columns:h.columns(),showFilter:h.config.allowFiltering}),ko.bindingHandlers.template.init(c,b(h),e,h,g)},update:function(c,d,e,f,g){var h,i;return h=a.gridManager.getGrid(c),h?(i=ko.bindingHandlers.template.update(c,b(h),e,h,g),a.domUtility.assignGridContainers(c,h),a.gridManager.assignGridEventHandlers(h),h.update(),i):{controlsDescendantBindings:!0}}}}(),ko.bindingHandlers.kgRows=function(){var b=function(){this.rowKey,this.rowIndex,this.node,this.subscription},c=function(a,b){return rowMap={},newRows=[],rowSubscriptionsToRemove=[],ko.utils.arrayForEach(a,function(a){rowMap[a.rowIndex]=a;var c=b[a.rowIndex];c?c.rowKey!==a.rowKey&&newRows.push(a):newRows.push(a)}),d.forIn(b,function(a,b){var c=rowMap[b];c?c.rowKey!==a.rowKey&&rowSubscriptionsToRemove.push(a):rowSubscriptionsToRemove.push(a)}),{add:newRows,remove:rowSubscriptionsToRemove}};return{init:function(){return{controlsDescendantBindings:!0}},update:function(d,e,f,g,h){var i=h.$data.rowManager,j=ko.utils.unwrapObservable(e()),k=h.$data,l;return l=c(j,i.rowSubscriptions||{}),ko.utils.arrayForEach(l.remove,function(a){a.node&&ko.removeNode(a.node),a.subscription.dispose(),delete i.rowSubscriptions[a.rowIndex]}),ko.utils.arrayForEach(l.add,function(a){var c,e,f=document.createElement("DIV");c=h.createChildContext(a),d.appendChild(f),e=new b,e.rowKey=a.rowKey,e.rowIndex=a.rowIndex,i.rowSubscriptions[a.rowIndex]=e,e.subscription=ko.renderTemplate(k.config.rowTemplate,c,null,f,"replaceNode")}),k.elementsNeedMeasuring&&k.initPhase>0&&a.domUtility.measureRow($(d),k),{controlsDescendantBindings:!0}}}}(),ko.bindingHandlers.kgRow=function(){return{init:function(a,b,c,d,e){},update:function(a,b,c,d,e){var f=b(),g="kgRow",h=e.$parent,i=e.$parent.rowManager,j;h.config.canSelectRows&&(g+=" kgCanSelect"),g+=f.rowIndex%2===0?" even":" odd",a._kg_rowIndex_=f.rowIndex,a.style.top=f.offsetTop+"px",a.className=g,j=i.rowSubscriptions[f.rowIndex],j&&(j.node=a)}}}(),ko.bindingHandlers.kgCell=function(){var a=function(a){var b;return a.column.field==="rowIndex"?function(){return a.row.rowDisplayIndex}:function(){return a.data}};return{init:function(a,b,c,d,e){},update:function(b,c,d,e,f){var g=c(),h,i=f.$data;h=i.cellMap[g.value],b.className+=" kgCell col"+h.column.index+" ",h.column.field!=="__kg_selected__"&&!h.column.hasCellTemplate&&ko.bindingHandlers.text.update(b,a(h))}}}(),ko.bindingHandlers.kgHeaderRow=function(){var b=function(b){var c=b.columns(),e,f=new a.HeaderRow;d.forEach(c,function(b,c){e=new a.HeaderCell(b),e.colIndex=c,f.headerCells.push(e),f.headerCellMap[b.field]=e}),b.headerRow=f,b.headerRow.height=b.config.headerRowHeight},c=function(a){return function(){return{name:a.config.headerTemplate,data:a.headerRow}}};return{init:function(a,d,e,f,g){var h=g.$data;return b(h),ko.bindingHandlers.template.init(a,c(h),e,h,g)},update:function(a,b,d,e,f){var g=f.$data;return ko.bindingHandlers.template.update(a,c(g),d,g,f)}}}(),ko.bindingHandlers.kgHeader=function(){var a=function(a,b){return function(){return{name:a.headerTemplate||b.config.headerCellTemplate,data:a}}};return{init:function(a,b,c,d,e){var f=e.$data,g,h,i=b();if(i){h=i.value,g=f.headerCellMap[h];if(g&&h!=="rowIndex"&&h!=="__kg_selected__")return{controlsDescendantBindings:!0}}},update:function(b,c,d,e,f){var g=f.$data,h=f.$parent,i,j,k=c();if(k){j=k.value,i=g.headerCellMap[j];if(i){b.className+=" kgHeaderCell col"+i.colIndex+" ",i.headerClass&&(b.className+=" "+i.headerClass);if(j!=="rowIndex"&&j!=="__kg_selected__")return ko.bindingHandlers.template.update(b,a(i,h),d,e,f)}}}}}(),ko.bindingHandlers.kgFooter=function(){var b=function(a){return function(){return{name:a.config.footerTemplate,data:a.footer}}},c=function(a,b){return a.createChildContext(b)};return{init:function(d,e,f,g,h){var i=h.$data;return i.footer=new a.Footer(i),ko.bindingHandlers.template.init(d,b(i),f,i,c(h,i.footer))},update:function(a,d,e,f,g){var h=g.$data;return ko.bindingHandlers.template.update(a,b(h),e,h,c(g,h.footer))}}}(),ko.bindingHandlers.kgSize=function(){return{init:function(a,b,c,d,e){},update:function(a,b,c,d,e){var f=$(a),g=f.parent(),h=ko.utils.unwrapObservable(b()),i=f.outerHeight(),j=f.outerWidth();h.autoFitHeight&&(h.outerHeight=g.height());if(h.innerHeight&&h.innerWidth){f.height(h.innerHeight),f.width(h.innerWidth);return}if(i!==h.outerHeight||j!==h.outerWidth)f.height(h.outerHeight).width(h.outerWidth),i=f.outerHeight(),j=f.outerWidth(),h.heightDiff=i-f.height(),h.widthDiff=j-f.width(),f.height(h.outerHeight-h.heightDiff),f.width(h.outerWidth-h.widthDiff)}}}()})();